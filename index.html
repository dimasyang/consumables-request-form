<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å—æµ·è±ï½œåŒ…è£è€—æé ˜ç”¨ï¼ˆæ¥µç°¡æ‰‹æ©Ÿç‰ˆï½œå…¥/å‡ºåº«ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  :root {
    --nhf-bg: #f3f4f6;
    --nhf-card: #ffffff;
    --nhf-border: #e5e7eb;
    --nhf-text: #111827;
    --nhf-muted: #6b7280;
    --nhf-primary: #0f766e;
    --nhf-primary-soft: #ccfbf1;
    --nhf-danger: #b91c1c;
    --nhf-accent: #f97316;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", system-ui, sans-serif;
    background: radial-gradient(circle at top, #e5f3ff 0, #f3f4f6 45%, #e5e7eb 100%);
    color: var(--nhf-text);
  }
  .top-bar {
    height: 4px;
    width: 100%;
    background: linear-gradient(90deg, #0f766e, #14b8a6, #f97316);
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
  }
  .app {
    max-width: 960px;
    margin: 0 auto;
    padding: 12px 10px 16px;
  }
  h1 {
    font-size: 1.05rem;
    margin: 0;
    font-weight: 700;
    letter-spacing: 0.03em;
    color: #0b1120;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  h1::before {
    content: "ğŸ“¦";
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 999px;
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: #ecfeff;
    font-size: 0.8rem;
  }
  .sub {
    font-size: 0.78rem;
    color: var(--nhf-muted);
    margin-top: 4px;
    margin-bottom: 10px;
  }
  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    margin-bottom: 8px;
    font-size: 0.8rem;
    padding: 8px 10px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.85);
    border: 1px solid rgba(148, 163, 184, 0.4);
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
  }
  .row span:first-child { font-weight: 600; color: #0f172a; }
  select, button, input[type="text"], input[type="number"], textarea { font-family: inherit; font-size: 0.8rem; }
  select {
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #d4d4d8;
    background: #f9fafb;
    outline: none;
  }
  select:focus {
    border-color: #0f766e;
    box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.35);
    background: #ffffff;
  }
  #monthInfo { font-size: 0.8rem; color: var(--nhf-muted); margin-left: auto; }
  .toolbar {
    position: sticky;
    top: 0;
    z-index: 15;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 10px 0 8px;
    padding: 8px 10px;
    background: rgba(248, 250, 252, 0.96);
    backdrop-filter: blur(12px);
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
  }
  button {
    padding: 6px 11px;
    border-radius: 999px;
    border: 1px solid #d4d4d8;
    background: #ffffff;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    white-space: nowrap;
    transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, border-color 0.08s ease;
  }
  button:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12); background: #f9fafb; }
  button:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(15, 23, 42, 0.18); }
  button.primary {
    background: linear-gradient(135deg, var(--nhf-primary), #14b8a6);
    color: #ecfeff;
    border-color: #0f766e;
    box-shadow: 0 6px 14px rgba(15, 118, 110, 0.4);
  }
  button.primary:hover { background: linear-gradient(135deg, #0d9488, #22c55e); }
  button.danger { background: #fef2f2; color: var(--nhf-danger); border-color: #fecaca; }
  button.danger:hover { background: #fee2e2; }
  .summary {
    font-size: 0.8rem;
    margin-bottom: 8px;
    padding: 8px 10px;
    border-radius: 10px;
    background: linear-gradient(135deg, #ecfeff, #fefce8);
    border: 1px solid rgba(148, 163, 184, 0.4);
    display: grid;
    row-gap: 2px;
  }
  .summary strong { color: var(--nhf-accent); font-weight: 700; }
  .search-box {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    margin-bottom: 4px;
    font-size: 0.8rem;
    padding: 6px 10px;
    border-radius: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
  }
  .search-box span { color: #0f172a; font-weight: 500; }
  .search-box input {
    flex: 1;
    min-width: 120px;
    padding: 5px 8px;
    border-radius: 999px;
    border: 1px solid #d4d4d8;
    background: #ffffff;
    outline: none;
  }
  .search-box input:focus { border-color: #0f766e; box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.3); }
  .info { font-size: 0.72rem; color: var(--nhf-muted); margin: 4px 2px 6px; }
  .ranking-toggle-row { margin-bottom: 6px; }
  .ranking-section {
    display: none;
    padding: 8px 10px;
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin-bottom: 10px;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
  }
  .ranking-section > div { font-size: 0.78rem; margin-bottom: 6px; font-weight: 500; color: #0f172a; }
  .ranking-section table { width: 100%; border-collapse: collapse; font-size: 0.72rem; }
  .ranking-section th, .ranking-section td { border-bottom: 1px solid #e5e7eb; padding: 4px 4px; text-align: left; white-space: nowrap; }
  .ranking-section th { font-weight: 600; color: #4b5563; }
  .items { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; }
  .item-card {
    background: var(--nhf-card);
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    padding: 8px 10px 8px;
    font-size: 0.8rem;
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.09);
  }
  .item-header { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; margin-bottom: 6px; }
  .index-badge { font-size: 0.72rem; padding: 2px 6px; border-radius: 999px; background: #e5e7eb; color: #374151; font-weight: 600; }
  .item-header input[type="text"] {
    padding: 4px 6px;
    border-radius: 999px;
    border: 1px solid #d4d4d8;
    background: #f9fafb;
    min-width: 70px;
    outline: none;
  }
  .item-header input[type="text"]:focus { border-color: #0f766e; background: #ffffff; box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.25); }
  .item-header input[type="text"]:last-child { flex: 1; }
  .line { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px; align-items: center; }
  .line label { font-size: 0.72rem; color: #4b5563; padding: 2px 4px; border-radius: 999px; background: #f3f4f6; }
  .line input[type="text"], .line input[type="number"] {
    padding: 3px 6px;
    min-width: 60px;
    border-radius: 8px;
    border: 1px solid #d4d4d8;
    background: #f9fafb;
    outline: none;
  }
  .line input[type="text"]:focus, .line input[type="number"]:focus { border-color: #0f766e; background: #ffffff; box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.25); }
  textarea {
    width: 100%;
    padding: 4px 6px;
    resize: vertical;
    min-height: 40px;
    border-radius: 10px;
    border: 1px solid #d4d4d8;
    background: #f9fafb;
    font-size: 0.78rem;
    outline: none;
  }
  textarea:focus { border-color: #0f766e; background: #ffffff; box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.22); }
  .days { margin-top: 6px; border-top: 1px dashed #e5e7eb; padding-top: 6px; }
  .days-title { font-size: 0.75rem; color: #4b5563; margin-bottom: 4px; font-weight: 500; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .days-hint { font-size: 0.72rem; color:#64748b; }
  .days-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(86px, 1fr)); gap: 4px; }
  .day-cell {
    display: flex;
    flex-direction: column;
    font-size: 0.72rem;
    padding: 4px;
    border-radius: 8px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    gap: 3px;
  }
  .day-cell span { color: #4b5563; margin-bottom: 1px; }
  .day-cell input {
    padding: 3px 4px;
    border-radius: 6px;
    border: 1px solid #d4d4d8;
    background: #ffffff;
    outline: none;
  }
  .day-cell input:focus { border-color: #0f766e; box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.2); }
  .item-footer { margin-top: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; padding-top: 4px; }
  .item-footer strong { color: var(--nhf-accent); }
  .item-footer button.danger { font-size: 0.72rem; padding-inline: 10px; }
  @media (max-width: 640px) {
    .app { padding-inline: 8px; }
    .toolbar { top: 0; padding-inline: 8px; }
    #monthInfo { width: 100%; margin-left: 0; margin-top: 2px; }
  }
  .photo-line { align-items: flex-start; }
  .photo-actions { display: flex; flex-direction: column; gap: 4px; }
  .photo-preview { width: 80px; height: 80px; border-radius: 8px; border: 1px solid #e5e7eb; object-fit: cover; margin-left: 4px; }
  .photo-note { font-size: 0.72rem; color: #6b7280; }
  .photo-status { font-size: 0.72rem; margin-top: 2px; }
  .photo-status-ok { color: #16a34a; }
  .photo-status-warn { color: #f97316; }
  .photo-status-wait { color: #0f766e; }
  .photo-line input[type="file"] { font-size: 0.72rem; }
  .gallery-toggle-btn { font-size: 0.8rem; padding: 5px 8px; border-radius: 999px; border: 1px dashed #0f766e; background: #ecfeff; color: #0f766e; }
  .gallery-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.75);
    backdrop-filter: blur(10px);
    z-index: 40;
    display: none;
    flex-direction: column;
    padding: 10px;
  }
  .gallery-overlay.active { display: flex; }
  .gallery-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #f9fafb; }
  .gallery-header-title { font-size: 0.9rem; font-weight: 600; }
  .gallery-close-btn {
    margin-left: auto;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.8);
    background: transparent;
    color: #e5e7eb;
    font-size: 0.8rem;
  }
  .gallery-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; overflow-y: auto; }
  .gallery-item { background: #0b1120; border-radius: 10px; padding: 4px; border: 1px solid rgba(148,163,184,0.5); }
  .gallery-thumb { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 8px; margin-bottom: 2px; }
  .gallery-caption { font-size: 0.68rem; color: #e5e7eb; line-height: 1.2; }
  .lightbox { position: fixed; inset: 0; background: rgba(15,23,42,0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 10px; }
  .lightbox.active { display: flex; }
  .lightbox-img { max-width: 100%; max-height: 100%; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
  .app.closed-mode .item-card input,
  .app.closed-mode .item-card select,
  .app.closed-mode .item-card textarea,
  .app.closed-mode .item-card button { pointer-events: none; opacity: 0.6; }
  .app.closed-mode .item-card .photo-preview { pointer-events: none; }
  #closeNote { margin-top: 4px; }
</style>
</head>
<body>
  <div class="top-bar"></div>
  <div class="app">
    <h1>å—æµ·è± åŒ…è£è€—æé ˜ç”¨ï¼ˆæ¥µç°¡æ‰‹æ©Ÿç‰ˆï½œå…¥/å‡ºåº«ï¼‰</h1>
    <div class="sub">å¤šå¹´ä»½ Â· å–®æ©Ÿä½¿ç”¨ Â· è³‡æ–™ä¿å­˜åœ¨ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ï¼‹å¯åŒæ­¥ Firestoreï¼›æ¯æ—¥åŒæ™‚è¨˜ã€Œå…¥åº«/å‡ºåº«ã€ï¼Œæœˆåº•ç›¤é»æ›´æº–ã€‚</div>
    <div id="closeNote" class="info"></div>

    <div class="row">
      <span>ğŸ“† å¹´æœˆï¼š</span>
      <select id="yearSelect" onchange="onYearMonthChange()">
        <option value="114">114 å¹´</option>
        <option value="115">115 å¹´</option>
        <option value="116">116 å¹´</option>
        <option value="117">117 å¹´</option>
      </select>
      <select id="monthSelect" onchange="onYearMonthChange()">
        <option value="11">11 æœˆ</option>
        <option value="12">12 æœˆ</option>
        <option value="1">1 æœˆ</option>
        <option value="2">2 æœˆ</option>
        <option value="3">3 æœˆ</option>
        <option value="4">4 æœˆ</option>
        <option value="5">5 æœˆ</option>
        <option value="6">6 æœˆ</option>
        <option value="7">7 æœˆ</option>
        <option value="8">8 æœˆ</option>
        <option value="9">9 æœˆ</option>
        <option value="10">10 æœˆ</option>
      </select>
      <span id="monthInfo">ç›®å‰ï¼š114 å¹´ 11 æœˆ</span>
    </div>

    <div class="toolbar">
      <button class="primary" onclick="addItem()">ï¼‹ æ–°å¢å“é …</button>
      <button onclick="saveData()">ğŸ’¾ å„²å­˜æœ¬æœˆè³‡æ–™</button>
      <button onclick="exportCsv()">ğŸ“¤ åŒ¯å‡ºæœ¬æœˆå ±è¡¨</button>
      <button onclick="showTodayOnly()">ğŸ“… åªçœ‹ä»Šå¤©</button>
      <button onclick="showAllDays()">ğŸ—“ é¡¯ç¤ºå…¨éƒ¨æ—¥æœŸ</button>
      <button class="danger" onclick="clearData()">ğŸ§¹ æ¸…é™¤æœ¬æœˆæš«å­˜</button>
      <button class="gallery-toggle-btn" onclick="openGallery()">ğŸ“· ç…§ç‰‡ç¸½è¦½</button>
      <button id="closeBtn" onclick="toggleCloseMonth()">ğŸ”’ æœ¬æœˆé—œå¸³</button>
    </div>

    <div class="summary">
      <div>ğŸ“… æœ¬æœˆå¤©æ•¸ï¼š<span id="daysInfo">30 å¤©</span> <span id="dayFilterInfo"></span></div>
      <div>ğŸ’° æœ¬æœˆç´¯è¨ˆå‡ºåº«é‡‘é¡ï¼ˆä»¥å–®åƒ¹Ã—å‡ºåº«é‡ï¼‰ï¼š<strong id="grandTotal">0</strong> å…ƒ</div>
      <div>ğŸ“¦ å“é …æ•¸é‡ï¼š<span id="itemCount">0</span> å€‹</div>
    </div>

    <div class="search-box">
      <span>ğŸ” æœå°‹å“é …ï¼š</span>
      <input id="searchInput" type="text" placeholder="çœŸç©ºè¢‹ / ç´™ç®± / è²¼ç´™â€¦" oninput="onSearchChange()" />
      <button onclick="resetSearch()">æ¸…é™¤æœå°‹</button>
    </div>
    <div class="info" id="searchInfo"></div>

    <div class="ranking-toggle-row">
      <button id="rankingToggleBtn" onclick="toggleRanking()">ğŸ“Š é¡¯ç¤ºæ’è¡Œ</button>
    </div>

    <div id="rankingSection" class="ranking-section">
      <div>ğŸ“Š æœ¬æœˆå‡ºåº«ç”¨é‡æ’è¡Œï¼ˆä¾å‡ºåº«ç¸½é‡ï¼Œç”±å¤§åˆ°å°ï¼‰</div>
      <table>
        <thead>
          <tr>
            <th>#</th><th>å“é …</th><th>å“å</th><th>å‡ºåº«ç¸½é‡</th><th>å‡ºåº«é‡‘é¡å°è¨ˆ</th>
          </tr>
        </thead>
        <tbody id="rankingBody"></tbody>
      </table>
    </div>

    <div class="gallery-overlay" id="galleryOverlay">
      <div class="gallery-header">
        <div class="gallery-header-title">ğŸ“· è€—æç…§ç‰‡ç¸½è¦½</div>
        <input id="gallerySearch" type="text" placeholder="æœå°‹å“é … / å“å / å» å•†" style="flex:1; max-width:210px; padding:4px 8px; border-radius:999px; border:1px solid #cbd5f5; font-size:0.75rem;">
        <button class="gallery-close-btn" onclick="closeGallery()">é—œé–‰</button>
      </div>
      <div class="gallery-grid" id="galleryGrid"></div>
    </div>

    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
      <img id="lightboxImg" class="lightbox-img" src="" alt="è€—æç…§ç‰‡é è¦½">
    </div>

    <div class="items" id="itemsContainer"></div>
  </div>

  <script>
    // TEMPLATE_ITEMS ä¿ç•™èˆŠçš„ dailyï¼ˆèˆŠç‰ˆé ˜ç”¨ï¼‰ï¼Œæ–°ç‰ˆæœ¬æœƒåœ¨ ensureDailyIOArrays è‡ªå‹•æ¬åˆ° dailyOut
    const TEMPLATE_ITEMS = [
      {"category":"çœŸç©ºè¢‹","supplier":"åŒ…è£å·¥å ´","name":"é£Ÿå“ç´šçœŸç©ºåŒ…è£è¢‹","spec":"(1.)NY2030\n20 x 30 cm+åš0.09mm","unit":"100å…¥/åŒ…","unitPrice":240.0,"daily":Array(31).fill(null),"usageType":"ä¸¸ã€é­š","note":"åŒ…è£å·¥å ´\n0918-199246\n0958-199246\n0956-199246\n\nLINEï¼šåŒ…è£å·¥å ´"},
      {"category":null,"supplier":null,"name":null,"spec":"(2.)NY1737\n17 x 37 cm+åš0.08mm","unit":null,"unitPrice":1.9,"daily":Array(31).fill(null),"usageType":"é®­","note":null},
      {"category":null,"supplier":null,"name":null,"spec":"(3.)NY1727\n17 x 27 cm+åš0.08mm","unit":null,"unitPrice":1.35,"daily":Array(31).fill(null),"usageType":"é¯–","note":null},
      {"category":null,"supplier":null,"name":null,"spec":"(4.)NY1547\n15.5 x 47cm+åš0.08mm","unit":null,"unitPrice":2.25,"daily":Array(31).fill(null),"usageType":"å°¾å·´","note":null}
    ];

    let currentYear = 114;
    let currentMonth = 11;
    let items = [];
    let filteredIndices = [];
    let currentDayFilter = null;
    let rankingVisible = false;
    let unsubscribeRealtime = null;
    let monthClosed = false;

    // ------- ç…§ç‰‡ç©©å®šç‰ˆï¼ˆAæ–¹æ¡ˆï¼‰è¨­å®š -------
    const PHOTO_MAX_WIDTH = 1200;
    const PHOTO_MAX_HEIGHT = 1200;
    const PHOTO_MAX_SIZE_KB = 350;
    const PHOTO_MAX_RAW_MB = 8;

    function ensureItemId(item) {
      if (!item) return "unknown";
      if (!item.id || typeof item.id !== "string") {
        if (typeof crypto !== "undefined" && crypto.randomUUID) {
          item.id = crypto.randomUUID();
        } else {
          item.id = "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
        }
      }
      return item.id;
    }

    function sanitizeItem(item) {
      if (!item || typeof item !== "object") return item;
      const keys = ["category","supplier","name","spec","unit","usageType","note","photoUrl"];
      keys.forEach(k => {
        if (typeof item[k] === "number" && isNaN(item[k])) item[k] = null;
      });
      if (typeof item.unitPrice === "number" && isNaN(item.unitPrice)) item.unitPrice = null;
      ensureItemId(item);
      return item;
    }

    function adYear(rocYear) { return rocYear + 1911; }
    function daysInMonth(rocYear, month) {
      const y = adYear(rocYear);
      return new Date(y, month, 0).getDate();
    }
    function getDaysInCurrentMonth() { return daysInMonth(currentYear, currentMonth); }
    function storageKeyForCurrent() { return "nhf_packing_inout_R" + currentYear + "_M" + currentMonth; }
    function formatMoney(num) {
      if (num == null || isNaN(num)) return "0";
      return Math.round(num).toLocaleString("zh-TW");
    }

    // -------- å…¥/å‡ºåº«æ¯æ—¥é™£åˆ—ï¼šç›¸å®¹èˆŠè³‡æ–™ daily -> dailyOut --------
    function ensureDailyIOArrays(item) {
      const DAYS = getDaysInCurrentMonth();

      if (Array.isArray(item.daily) && !Array.isArray(item.dailyOut)) {
        item.dailyOut = item.daily.slice(0, DAYS);
      }
      if (!Array.isArray(item.dailyIn)) item.dailyIn = Array(DAYS).fill(null);
      if (!Array.isArray(item.dailyOut)) item.dailyOut = Array(DAYS).fill(null);

      if (item.dailyIn.length < DAYS) item.dailyIn = item.dailyIn.concat(Array(DAYS - item.dailyIn.length).fill(null));
      if (item.dailyIn.length > DAYS) item.dailyIn = item.dailyIn.slice(0, DAYS);

      if (item.dailyOut.length < DAYS) item.dailyOut = item.dailyOut.concat(Array(DAYS - item.dailyOut.length).fill(null));
      if (item.dailyOut.length > DAYS) item.dailyOut = item.dailyOut.slice(0, DAYS);
    }

    function sumArrayNumeric(arr) {
      return (arr || []).reduce((s, v) => s + (isNaN(parseFloat(v)) ? 0 : parseFloat(v)), 0);
    }

    function getItemTotals(item) {
      ensureDailyIOArrays(item);
      const inQty = sumArrayNumeric(item.dailyIn);
      const outQty = sumArrayNumeric(item.dailyOut);
      return { inQty, outQty, netQty: inQty - outQty };
    }

    function calcTotal(item) {
      const price = parseFloat(item.unitPrice || 0) || 0;
      const { outQty } = getItemTotals(item);
      return price * outQty; // é‡‘é¡ä»¥å‡ºåº«ï¼ˆé ˜ç”¨ï¼‰è¨ˆ
    }

    function getFilteredIndicesByKeyword(keyword) {
      if (!keyword) return [];
      const kw = keyword.toLowerCase();
      const res = [];
      items.forEach((item, idx) => {
        const fields = [item.category||"", item.name||"", item.supplier||"", item.spec||"", item.usageType||""].join(" ").toLowerCase();
        if (fields.includes(kw)) res.push(idx);
      });
      return res;
    }

    function updateGrandTotal() {
      let grand = 0;
      const indices = filteredIndices.length ? filteredIndices : items.map((_, i) => i);
      indices.forEach(idx => { grand += calcTotal(items[idx]); });
      document.getElementById("grandTotal").textContent = formatMoney(grand);
    }

    function updateRanking() {
      const tbody = document.getElementById("rankingBody");
      tbody.innerHTML = "";
      if (!rankingVisible) return;

      const stats = items.map((item, idx) => {
        const { outQty } = getItemTotals(item);
        return ({
          index: idx,
          category: item.category || "",
          name: item.name || "",
          qty: outQty,
          amt: calcTotal(item)
        });
      });
      stats.sort((a, b) => (b.qty !== a.qty ? b.qty - a.qty : b.amt - a.amt));
      stats.slice(0, 20).forEach((s, i) => {
        const tr = document.createElement("tr");
        [""+(i+1), s.category, s.name, (s.qty||""), (s.amt ? formatMoney(s.amt) : "")].forEach(val=>{
          const td=document.createElement("td"); td.textContent=val; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // -------- å¿«é€Ÿä»Šå¤©å…¥/å‡ºåº« --------
    function isTodayInSelectedMonth() {
      const today = new Date();
      const adY = adYear(currentYear);
      return today.getFullYear() === adY && (today.getMonth() + 1) === currentMonth;
    }
    function getTodayIndexOrNull() {
      const today = new Date();
      const day = today.getDate();
      const DAYS = getDaysInCurrentMonth();
      if (day < 1 || day > DAYS) return null;
      return day - 1;
    }
    function quickAddForToday(item, mode, totalSpan, refreshStockInfo) {
      ensureDailyIOArrays(item);

      if (!isTodayInSelectedMonth()) {
        const ok = confirm("âš ï¸ ä»Šå¤©ä¸æ˜¯ç›®å‰é¸å®šçš„å¹´æœˆï¼ˆ" + currentYear + "/" + currentMonth + "ï¼‰ã€‚ä»è¦åŠ åˆ°ã€Œä»Šå¤©ã€æ¬„ä½å—ï¼Ÿ");
        if (!ok) return;
      }
      const idx = getTodayIndexOrNull();
      if (idx == null) { alert("ä»Šå¤©æ—¥æœŸè¶…å‡ºæœ¬æœˆå¤©æ•¸ï¼Œç„¡æ³•å¯«å…¥ã€‚"); return; }

      const label = (mode === "in") ? "å…¥åº«" : "å‡ºåº«";
      const input = prompt("ï¼‹ä»Šå¤©" + label + "ï¼šè«‹è¼¸å…¥æ•¸é‡ï¼ˆå¯è¼¸å…¥å°æ•¸ï¼‰", "1");
      if (input == null) return;

      const addQty = parseFloat(String(input).trim());
      if (isNaN(addQty)) { alert("è¼¸å…¥ä¸æ˜¯æ•¸å­—ï¼Œå·²å–æ¶ˆã€‚"); return; }

      if (mode === "in") {
        const cur = parseFloat(item.dailyIn[idx]) || 0;
        item.dailyIn[idx] = cur + addQty;
      } else {
        const cur = parseFloat(item.dailyOut[idx]) || 0;
        item.dailyOut[idx] = cur + addQty;
      }

      if (totalSpan) totalSpan.textContent = formatMoney(calcTotal(item));
      updateGrandTotal();
      updateRanking();
      if (typeof refreshStockInfo === "function") refreshStockInfo();

      renderItems(); // è®“ä»Šå¤©æ¬„ä½ç«‹å³å¯è¦‹
    }

    function compressImage(file, maxWidth, maxHeight, maxSizeKB, callback) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          let width = img.width;
          let height = img.height;
          const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
          width = width * ratio;
          height = height * ratio;

          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          let quality = 0.9;
          function tryExport() {
            canvas.toBlob(
              function (blob) {
                if (!blob) { alert("åœ–ç‰‡å£“ç¸®å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µç…§ç‰‡ã€‚"); return; }
                const sizeKB = blob.size / 1024;
                if (sizeKB > maxSizeKB && quality > 0.3) { quality -= 0.1; tryExport(); }
                else if (sizeKB > maxSizeKB) { alert("åœ–ç‰‡ä»è¶…éé™åˆ¶å¤§å°ï¼ˆ" + maxSizeKB + "KBï¼‰ï¼Œè«‹æ‹å°ä¸€é»æˆ–å…ˆç¸®åœ–ã€‚"); }
                else {
                  const reader2 = new FileReader();
                  reader2.onload = function (ev) { callback(ev.target.result, blob); };
                  reader2.readAsDataURL(blob);
                }
              },
              "image/jpeg",
              quality
            );
          }
          tryExport();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function openLightbox(src) {
      document.getElementById("lightboxImg").src = src;
      document.getElementById("lightbox").classList.add("active");
    }
    function closeLightbox() { document.getElementById("lightbox").classList.remove("active"); }

    function openGallery() {
      document.getElementById("galleryOverlay").classList.add("active");
      document.getElementById("gallerySearch").value = "";
      renderGallery();
    }
    function closeGallery() { document.getElementById("galleryOverlay").classList.remove("active"); }

    function renderGallery() {
      const grid = document.getElementById("galleryGrid");
      const kw = (document.getElementById("gallerySearch").value || "").toLowerCase().trim();
      grid.innerHTML = "";
      items.forEach((item) => {
        if (!item || !item.photoUrl) return;
        const fields = [item.category||"", item.name||"", item.supplier||"", item.usageType||"", item.spec||""].join(" ").toLowerCase();
        if (kw && !fields.includes(kw)) return;

        const div = document.createElement("div");
        div.className = "gallery-item";

        const img = document.createElement("img");
        img.className = "gallery-thumb";
        img.src = item.photoUrl;
        img.onclick = () => openLightbox(item.photoUrl);
        div.appendChild(img);

        const cap = document.createElement("div");
        cap.className = "gallery-caption";
        cap.textContent = (item.category || "æœªå¡«å“é …") + "ï½œ" + (item.name || "") + (item.supplier ? ("ï½œ" + item.supplier) : "");
        div.appendChild(cap);

        grid.appendChild(div);
      });
    }

    function renderItems() {
      const container = document.getElementById("itemsContainer");
      container.innerHTML = "";
      const indices = filteredIndices.length ? filteredIndices : items.map((_, i) => i);

      document.getElementById("daysInfo").textContent = getDaysInCurrentMonth() + " å¤©";
      document.getElementById("dayFilterInfo").textContent = currentDayFilter ? ("ï½œç›®å‰åªé¡¯ç¤ºæ—¥æœŸï¼š" + currentMonth + "/" + currentDayFilter) : "";

      indices.forEach((realIdx) => {
        const item = items[realIdx];
        ensureDailyIOArrays(item);

        const card = document.createElement("div");
        card.className = "item-card";

        const header = document.createElement("div");
        header.className = "item-header";

        const idxSpan = document.createElement("span");
        idxSpan.className = "index-badge";
        idxSpan.textContent = realIdx + 1;
        header.appendChild(idxSpan);

        const catInput = document.createElement("input");
        catInput.type = "text";
        catInput.placeholder = "å“é …";
        catInput.value = item.category || "";
        catInput.onchange = (e) => { item.category = e.target.value; };
        header.appendChild(catInput);

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "å“å";
        nameInput.value = item.name || "";
        nameInput.style.flex = "1";
        nameInput.onchange = (e) => { item.name = e.target.value; };
        header.appendChild(nameInput);

        card.appendChild(header);

        // --- ç…§ç‰‡ ---
        const photoLine = document.createElement("div");
        photoLine.className = "line photo-line";
        const photoLabel = document.createElement("label");
        photoLabel.textContent = "ç…§ç‰‡";
        photoLine.appendChild(photoLabel);

        const photoWrapper = document.createElement("div");
        photoWrapper.className = "photo-actions";

        const img = document.createElement("img");
        img.className = "photo-preview";
        if (item.photoUrl) img.src = item.photoUrl;
        else img.style.display = "none";
        img.onclick = () => { if (item.photoUrl) openLightbox(item.photoUrl); };
        photoWrapper.appendChild(img);

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.capture = "environment";

        const statusDiv = document.createElement("div");
        statusDiv.className = "photo-status";
        if (item.photoUrl) { statusDiv.textContent = "âœ… å·²æœ‰ç…§ç‰‡"; statusDiv.classList.add("photo-status-ok"); }
        else { statusDiv.textContent = "å°šæœªä¸Šå‚³ç…§ç‰‡"; }

        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const maxRawSizeMB = PHOTO_MAX_RAW_MB;
          if (file.size > maxRawSizeMB * 1024 * 1024) {
            alert("åŸå§‹ç…§ç‰‡è¶…é " + maxRawSizeMB + "MBï¼Œè«‹æ‹å°ä¸€é»å†ä¸Šå‚³ã€‚");
            e.target.value = "";
            return;
          }

          statusDiv.textContent = "å£“ç¸®ä¸­â€¦";
          statusDiv.classList.remove("photo-status-ok", "photo-status-warn");
          statusDiv.classList.add("photo-status-wait");

          compressImage(file, PHOTO_MAX_WIDTH, PHOTO_MAX_HEIGHT, PHOTO_MAX_SIZE_KB, function (dataUrl, blob) {
            if (typeof uploadPhotoToStorage === "function") {
              statusDiv.textContent = "ä¸Šå‚³é›²ç«¯ä¸­â€¦";
              const itemId = ensureItemId(item);
              const path = "consumables_photos/R" + currentYear + "/M" + currentMonth + "/" + itemId + ".jpg";
              uploadPhotoToStorage(blob, path)
                .then((url) => {
                  item.photoUrl = url;
                  img.src = url;
                  img.style.display = "block";
                  statusDiv.textContent = "âœ… é›²ç«¯å·²å„²å­˜";
                  statusDiv.classList.remove("photo-status-wait", "photo-status-warn");
                  statusDiv.classList.add("photo-status-ok");
                  renderGallery();
                })
                .catch((err) => {
                  console.error(err);
                  item.photoUrl = dataUrl;
                  img.src = dataUrl;
                  img.style.display = "block";
                  statusDiv.textContent = "âš  åƒ…å„²å­˜åœ¨æœ¬æ©Ÿï¼Œé›²ç«¯ä¸Šå‚³å¤±æ•—";
                  statusDiv.classList.remove("photo-status-wait", "photo-status-ok");
                  statusDiv.classList.add("photo-status-warn");
                  renderGallery();
                  alert("ä¸Šå‚³é›²ç«¯å¤±æ•—ï¼Œæš«æ™‚æ”¹ç‚ºæœ¬æ©Ÿé¡¯ç¤ºã€‚");
                });
            } else {
              item.photoUrl = dataUrl;
              img.src = dataUrl;
              img.style.display = "block";
              statusDiv.textContent = "âš  åƒ…å„²å­˜åœ¨æœ¬æ©Ÿï¼ˆæœªé€£ç·šé›²ç«¯ï¼‰";
              statusDiv.classList.remove("photo-status-wait", "photo-status-ok");
              statusDiv.classList.add("photo-status-warn");
              renderGallery();
            }
          });
        };
        photoWrapper.appendChild(fileInput);

        const clearPhotoBtn = document.createElement("button");
        clearPhotoBtn.type = "button";
        clearPhotoBtn.textContent = "æ¸…é™¤ç…§ç‰‡";
        clearPhotoBtn.className = "danger";
        clearPhotoBtn.onclick = () => {
          if (!item.photoUrl) return;
          if (confirm("è¦åˆªé™¤é€™å€‹è€—æçš„ç…§ç‰‡å—ï¼Ÿï¼ˆä¸æœƒåˆªé™¤é›²ç«¯æª”æ¡ˆï¼Œåªæœƒæ¸…é™¤é€£çµï¼‰")) {
            item.photoUrl = null;
            img.src = "";
            img.style.display = "none";
            statusDiv.textContent = "å°šæœªä¸Šå‚³ç…§ç‰‡";
            statusDiv.classList.remove("photo-status-ok", "photo-status-warn", "photo-status-wait");
            renderGallery();
          }
        };
        photoWrapper.appendChild(clearPhotoBtn);
        photoWrapper.appendChild(statusDiv);

        const photoNote = document.createElement("div");
        photoNote.className = "photo-note";
        photoNote.textContent = "å¯ç”¨æ‰‹æ©Ÿæ‹è€—æå¤–è§€ï¼Œç…§ç‰‡æœƒå£“ç¸®å¾Œä¸Šå‚³ï¼ˆæˆ–åªå­˜åœ¨æœ¬æ©Ÿï¼‰ï¼Œæ¬„ä½åƒ…å­˜é€£çµã€‚";
        photoWrapper.appendChild(photoNote);

        photoLine.appendChild(photoWrapper);
        card.appendChild(photoLine);

        // --- åŸºæœ¬æ¬„ä½ ---
        const line1 = document.createElement("div");
        line1.className = "line";
        line1.innerHTML = '<label>å» å•†</label><input type="text"><label>å–®ä½</label><input type="text"><label>å–®åƒ¹</label><input type="number">';
        const [supInput, unitInput, priceInput] = line1.querySelectorAll("input");
        supInput.value = item.supplier || "";
        unitInput.value = item.unit || "";
        priceInput.value = item.unitPrice == null ? "" : item.unitPrice;
        supInput.onchange = e => item.supplier = e.target.value;
        unitInput.onchange = e => item.unit = e.target.value;
        card.appendChild(line1);

        const line2 = document.createElement("div");
        line2.className = "line";
        line2.innerHTML = '<label>å‹è™Ÿ/è¦æ ¼</label>';
        card.appendChild(line2);

        const specTa = document.createElement("textarea");
        specTa.value = item.spec || "";
        specTa.placeholder = "å¯å¡«å¯« NY2030 20x30 ç­‰";
        specTa.onchange = (e) => { item.spec = e.target.value; };
        card.appendChild(specTa);

        const line3 = document.createElement("div");
        line3.className = "line";
        line3.innerHTML = '<label>é©ç”¨ç¨®é¡</label><input type="text"><label>å‚™è¨»</label><input type="text">';
        const [usageInput, noteInput] = line3.querySelectorAll("input");
        usageInput.value = item.usageType || "";
        noteInput.value = item.note || "";
        usageInput.onchange = e => item.usageType = e.target.value;
        noteInput.onchange = e => item.note = e.target.value;
        card.appendChild(line3);

        // --- åº«å­˜ ---
        const stockLine = document.createElement("div");
        stockLine.className = "line";
        const stockLabel = document.createElement("label");
        stockLabel.textContent = "åº«å­˜";
        stockLine.appendChild(stockLabel);

        const stockWrapper = document.createElement("div");
        stockWrapper.style.display = "flex";
        stockWrapper.style.flexDirection = "column";
        stockWrapper.style.gap = "4px";

        const stockRow = document.createElement("div");
        stockRow.style.display = "flex";
        stockRow.style.flexWrap = "wrap";
        stockRow.style.gap = "4px";

        const openingInput = document.createElement("input");
        openingInput.type = "number";
        openingInput.placeholder = "æœŸåˆ";
        openingInput.style.maxWidth = "90px";
        openingInput.value = item.openingQty == null ? "" : item.openingQty;

        const closingInput = document.createElement("input");
        closingInput.type = "number";
        closingInput.placeholder = "æœŸæœ«ç›¤é»";
        closingInput.style.maxWidth = "110px";
        closingInput.value = item.closingQty == null ? "" : item.closingQty;

        const stockInfo = document.createElement("div");
        stockInfo.className = "photo-note";

        function refreshStockInfo() {
          const opening = openingInput.value.trim() === "" ? 0 : (parseFloat(openingInput.value) || 0);
          const { inQty, outQty } = getItemTotals(item);
          const theoreticalEnd = opening + inQty - outQty;

          if (closingInput.value.trim() === "") {
            stockInfo.textContent = "æœ¬æœˆå…¥åº«ï¼š" + inQty + "ï½œæœ¬æœˆå‡ºåº«ï¼š" + outQty + "ï½œç†è«–çµå­˜ï¼ˆæœŸåˆï¼‹å…¥ï¼å‡ºï¼‰ï¼š" + theoreticalEnd + "ï¼ˆå°šæœªè¼¸å…¥ç›¤é»é‡ï¼‰";
          } else {
            const closing = parseFloat(closingInput.value) || 0;
            const diff = closing - theoreticalEnd;
            stockInfo.textContent = "æœ¬æœˆå…¥åº«ï¼š" + inQty + "ï½œæœ¬æœˆå‡ºåº«ï¼š" + outQty + "ï½œç†è«–çµå­˜ï¼š" + theoreticalEnd + "ï½œç›¤é»ï¼š" + closing + "ï½œå·®ç•°ï¼š" + diff;
          }
        }

        openingInput.onchange = (e) => { item.openingQty = e.target.value.trim() === "" ? null : parseFloat(e.target.value); refreshStockInfo(); };
        closingInput.onchange = (e) => { item.closingQty = e.target.value.trim() === "" ? null : parseFloat(e.target.value); refreshStockInfo(); };

        stockRow.appendChild(openingInput);
        stockRow.appendChild(closingInput);
        stockWrapper.appendChild(stockRow);
        stockWrapper.appendChild(stockInfo);

        // å¿«é€Ÿä»Šå¤©å…¥/å‡ºåº«æŒ‰éˆ•
        const footerQuick = document.createElement("div");
        footerQuick.style.display = "flex";
        footerQuick.style.flexWrap = "wrap";
        footerQuick.style.gap = "6px";

        const btnIn = document.createElement("button");
        btnIn.type = "button";
        btnIn.textContent = "ï¼‹ä»Šå¤©å…¥åº«";
        const btnOut = document.createElement("button");
        btnOut.type = "button";
        btnOut.textContent = "ï¼‹ä»Šå¤©å‡ºåº«";
        const btnClear = document.createElement("button");
        btnClear.type = "button";
        btnClear.className = "danger";
        btnClear.textContent = "æ¸…ç©ºä»Šå¤©";

        footerQuick.appendChild(btnIn);
        footerQuick.appendChild(btnOut);
        footerQuick.appendChild(btnClear);
        stockWrapper.appendChild(footerQuick);

        stockLine.appendChild(stockWrapper);
        card.appendChild(stockLine);

        // --- footer å°è¨ˆ ---
        const footer = document.createElement("div");
        footer.className = "item-footer";

        const totalLabel = document.createElement("div");
        totalLabel.innerHTML = 'å‡ºåº«é‡‘é¡å°è¨ˆï¼š<strong><span></span></strong> å…ƒ';
        const totalSpan = totalLabel.querySelector("span");
        totalSpan.textContent = formatMoney(calcTotal(item));
        footer.appendChild(totalLabel);

        priceInput.onchange = (e) => {
          const v = e.target.value.trim();
          item.unitPrice = v === "" ? null : parseFloat(v);
          totalSpan.textContent = formatMoney(calcTotal(item));
          updateGrandTotal();
          updateRanking();
          refreshStockInfo();
        };

        // ç¶å®šå¿«é€ŸæŒ‰éˆ•ï¼ˆè¦ç­‰ totalSpan / refreshStockInfo å·²å­˜åœ¨ï¼‰
        btnIn.onclick = () => quickAddForToday(item, "in", totalSpan, refreshStockInfo);
        btnOut.onclick = () => quickAddForToday(item, "out", totalSpan, refreshStockInfo);
        btnClear.onclick = () => {
          ensureDailyIOArrays(item);
          const idx = getTodayIndexOrNull();
          if (idx == null) { alert("ä»Šå¤©æ—¥æœŸè¶…å‡ºæœ¬æœˆå¤©æ•¸ã€‚"); return; }
          if (!confirm("è¦æ¸…ç©ºä»Šå¤©çš„å…¥/å‡ºæ•¸é‡å—ï¼Ÿ")) return;
          item.dailyIn[idx] = null;
          item.dailyOut[idx] = null;
          totalSpan.textContent = formatMoney(calcTotal(item));
          updateGrandTotal();
          updateRanking();
          refreshStockInfo();
          renderItems();
        };

        refreshStockInfo();

        // --- æ¯æ—¥å…¥/å‡º ---
        const daysDiv = document.createElement("div");
        daysDiv.className = "days";
        const title = document.createElement("div");
        title.className = "days-title";
        title.innerHTML = "æ¯æ—¥å…¥/å‡ºåº«æ•¸é‡ï¼ˆ" + currentMonth + " æœˆï¼‰ <span class='days-hint'>ï¼ˆä¸Šï¼šå…¥åº«ï½œä¸‹ï¼šå‡ºåº«ï¼‰</span>";
        daysDiv.appendChild(title);

        const grid = document.createElement("div");
        grid.className = "days-grid";
        const DAYS = getDaysInCurrentMonth();
        for (let d = 0; d < DAYS; d++) {
          const dayNumber = d + 1;
          if (currentDayFilter && dayNumber !== currentDayFilter) continue;

          const cell = document.createElement("div");
          cell.className = "day-cell";

          const lbl = document.createElement("span");
          lbl.textContent = currentMonth + "/" + dayNumber;
          cell.appendChild(lbl);

          const inInp = document.createElement("input");
          inInp.type = "number";
          inInp.placeholder = "å…¥";
          inInp.value = item.dailyIn[d] == null ? "" : item.dailyIn[d];
          inInp.onchange = (e) => {
            const v = e.target.value.trim();
            item.dailyIn[d] = v === "" ? null : parseFloat(v);
            totalSpan.textContent = formatMoney(calcTotal(item));
            updateGrandTotal();
            updateRanking();
            refreshStockInfo();
          };
          cell.appendChild(inInp);

          const outInp = document.createElement("input");
          outInp.type = "number";
          outInp.placeholder = "å‡º";
          outInp.value = item.dailyOut[d] == null ? "" : item.dailyOut[d];
          outInp.onchange = (e) => {
            const v = e.target.value.trim();
            item.dailyOut[d] = v === "" ? null : parseFloat(v);
            totalSpan.textContent = formatMoney(calcTotal(item));
            updateGrandTotal();
            updateRanking();
            refreshStockInfo();
          };
          cell.appendChild(outInp);

          grid.appendChild(cell);
        }
        daysDiv.appendChild(grid);
        card.appendChild(daysDiv);

        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "åˆªé™¤å“é …";
        delBtn.onclick = () => {
          if (confirm("ç¢ºå®šåˆªé™¤ç¬¬ " + (realIdx + 1) + " å€‹å“é …ï¼Ÿ")) {
            items.splice(realIdx, 1);
            filteredIndices = getFilteredIndicesByKeyword(document.getElementById("searchInput").value.trim());
            renderItems();
            updateGrandTotal();
            updateRanking();
          }
        };
        footer.appendChild(delBtn);

        card.appendChild(footer);
        container.appendChild(card);
      });

      document.getElementById("itemCount").textContent = items.length;
      document.getElementById("searchInfo").textContent = filteredIndices.length
        ? ("ç›®å‰é¡¯ç¤º " + filteredIndices.length + " / å…¨éƒ¨ " + items.length + " å€‹å“é …ã€‚")
        : ("ç›®å‰é¡¯ç¤ºå…¨éƒ¨ " + items.length + " å€‹å“é …ã€‚");

      updateGrandTotal();
      updateRanking();
    }

    function addItem() {
      const DAYS = getDaysInCurrentMonth();
      const obj = {
        category: "", supplier: "", name: "", spec: "", unit: "",
        unitPrice: null,
        dailyIn: Array(DAYS).fill(null),
        dailyOut: Array(DAYS).fill(null),
        usageType: "", note: "",
        openingQty: null, closingQty: null,
        photoUrl: null,
        id: null
      };
      sanitizeItem(obj);
      items.push(obj);
      filteredIndices = getFilteredIndicesByKeyword(document.getElementById("searchInput").value.trim());
      renderItems();
    }

    function saveData() {
      try { localStorage.setItem(storageKeyForCurrent(), JSON.stringify(items)); }
      catch (e) { alert("å„²å­˜å¤±æ•—ï¼š" + e.message); return; }

      if (typeof db !== "undefined" && db) {
        const docId = "R" + currentYear + "_M" + currentMonth;
        db.collection("consumablesMonths").doc(docId).set({
          rocYear: currentYear, month: currentMonth,
          items: items, closed: monthClosed,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(() => {
          alert("å·²å„²å­˜ " + currentYear + "/" + currentMonth + " çš„è³‡æ–™ï¼Œä¸¦åŒæ­¥åˆ°é›²ç«¯ã€‚");
        }).catch((err) => {
          console.error("Firestore åŒæ­¥å¤±æ•—", err);
          alert("å·²å„²å­˜åœ¨æœ¬æ©Ÿï¼Œä½†é›²ç«¯åŒæ­¥å¤±æ•—ï¼š" + err.message);
        });
      } else {
        alert("å·²å„²å­˜ " + currentYear + "/" + currentMonth + " çš„è³‡æ–™ï¼ˆåƒ…ä¿å­˜åœ¨æœ¬æ©Ÿï¼‰ã€‚");
      }
    }

    function clearData() {
      if (!confirm("ç¢ºå®šæ¸…é™¤ " + currentYear + "/" + currentMonth + " çš„æš«å­˜è³‡æ–™ä¸¦æ¢å¾©é è¨­ï¼Ÿ")) return;
      localStorage.removeItem(storageKeyForCurrent());
      loadYearMonth(currentYear, currentMonth, true);
    }

    function onSearchChange() {
      filteredIndices = getFilteredIndicesByKeyword(document.getElementById("searchInput").value.trim());
      renderItems();
    }
    function resetSearch() { document.getElementById("searchInput").value = ""; filteredIndices = []; renderItems(); }

    function showTodayOnly() {
      const today = new Date();
      const adY = adYear(currentYear);
      if (today.getFullYear() !== adY || (today.getMonth() + 1) !== currentMonth) {
        const ok = confirm("ä»Šå¤©ä¸æ˜¯ç›®å‰é¸å®šçš„å¹´æœˆï¼ˆ" + currentYear + "/" + currentMonth + "ï¼‰ã€‚ä»è¦åªé¡¯ç¤ºä»Šå¤©å—ï¼Ÿ");
        if (!ok) return;
      }
      const day = today.getDate();
      const DAYS = getDaysInCurrentMonth();
      currentDayFilter = (day > DAYS) ? null : day;
      if (day > DAYS) alert("ä»Šå¤©æ—¥æœŸè¶…éæœ¬æœˆå¤©æ•¸ï¼Œå°‡ç¶­æŒé¡¯ç¤ºå…¨éƒ¨æ—¥æœŸã€‚");
      renderItems();
    }
    function showAllDays() { currentDayFilter = null; renderItems(); }

    function toggleRanking() {
      rankingVisible = !rankingVisible;
      const sec = document.getElementById("rankingSection");
      const btn = document.getElementById("rankingToggleBtn");
      sec.style.display = rankingVisible ? "block" : "none";
      btn.textContent = rankingVisible ? "ğŸ“‰ æ”¶èµ·æ’è¡Œ" : "ğŸ“Š é¡¯ç¤ºæ’è¡Œ";
      updateRanking();
    }

    function exportCsv() {
      const DAYS = getDaysInCurrentMonth();
      const header = ["å“é …","å» å•†","å“å","å‹è™Ÿ/è¦æ ¼","åŒ…è£/å–®ä½","å–®åƒ¹"];
      for (let d = 1; d <= DAYS; d++) {
        header.push(currentMonth + "/" + d + " å…¥");
        header.push(currentMonth + "/" + d + " å‡º");
      }
      header.push("æœ¬æœˆå…¥åº«åˆè¨ˆ","æœ¬æœˆå‡ºåº«åˆè¨ˆ","å‡ºåº«é‡‘é¡å°è¨ˆ","é©ç”¨ç¨®é¡","å‚™è¨»");

      const rows = [header];
      items.forEach((item) => {
        ensureDailyIOArrays(item);
        const row = [
          item.category || "",
          item.supplier || "",
          item.name || "",
          (item.spec || "").replace(/\s+/g, " "),
          item.unit || "",
          item.unitPrice == null ? "" : item.unitPrice
        ];
        for (let d = 0; d < DAYS; d++) {
          row.push(item.dailyIn[d] == null ? "" : item.dailyIn[d]);
          row.push(item.dailyOut[d] == null ? "" : item.dailyOut[d]);
        }
        const { inQty, outQty } = getItemTotals(item);
        row.push(inQty);
        row.push(outQty);
        row.push(calcTotal(item));
        row.push(item.usageType || "");
        row.push((item.note || "").replace(/\s+/g, " "));
        rows.push(row);
      });

      const csv = rows.map(cols =>
        cols.map(v => {
          const s = String(v == null ? "" : v);
          if (s.includes(",") || s.includes('"') || s.includes("\n")) return '"' + s.replace(/"/g, '""') + '"';
          return s;
        }).join(",")
      ).join("\n");

      const BOM = "\uFEFF";
      const blob = new Blob([BOM + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "è€—æå…¥å‡ºåº«_" + currentYear + "_" + currentMonth + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function cloneTemplateForMonth() {
      const DAYS = getDaysInCurrentMonth();
      return TEMPLATE_ITEMS.map(src => {
        const obj = {
          category: src.category,
          supplier: src.supplier,
          name: src.name,
          spec: src.spec,
          unit: src.unit,
          unitPrice: src.unitPrice,
          daily: Array(DAYS).fill(null), // ä»ä¿ç•™èˆŠæ¬„ä½ä¾›ç›¸å®¹
          dailyIn: Array(DAYS).fill(null),
          dailyOut: Array(DAYS).fill(null),
          usageType: src.usageType,
          note: src.note,
          openingQty: src.openingQty || null,
          closingQty: src.closingQty || null,
          photoUrl: src.photoUrl || null,
          id: src.id || null
        };
        const clean = sanitizeItem(obj);
        ensureDailyIOArrays(clean);
        return clean;
      });
    }

    function loadYearMonth(rocYear, month, forceReset) {
      currentYear = rocYear;
      currentMonth = month;
      document.getElementById("monthInfo").textContent = "ç›®å‰ï¼š" + currentYear + " å¹´ " + currentMonth + " æœˆ";
      currentDayFilter = null;
      filteredIndices = [];
      document.getElementById("searchInput").value = "";

      if (unsubscribeRealtime) { unsubscribeRealtime(); unsubscribeRealtime = null; }
      monthClosed = false;
      updateCloseUI();

      let hasLocal = false;
      if (!forceReset) {
        const saved = localStorage.getItem(storageKeyForCurrent());
        if (saved) {
          try {
            items = JSON.parse(saved);
            if (Array.isArray(items)) {
              items = items.map(sanitizeItem);
              items.forEach(it => ensureDailyIOArrays(it));
              hasLocal = true;
              renderItems();
            }
          } catch (e) {
            console.warn("è§£æå·²å­˜è³‡æ–™å¤±æ•—ï¼Œæ”¹ç”¨é è¨­ï¼š", e);
          }
        }
      }

      const applyTemplateIfNeeded = () => {
        if (!hasLocal && (!items || !items.length)) {
          if (currentYear === 114 && currentMonth === 11) {
            items = JSON.parse(JSON.stringify(TEMPLATE_ITEMS));
            items = items.map(sanitizeItem);
            items.forEach(it => ensureDailyIOArrays(it));
          } else {
            items = cloneTemplateForMonth();
          }
          monthClosed = false;
          renderItems();
          updateCloseUI();
        }
      };

      if (typeof db !== "undefined" && db) {
        const docId = "R" + currentYear + "_M" + currentMonth;
        const docRef = db.collection("consumablesMonths").doc(docId);
        unsubscribeRealtime = docRef.onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            if (Array.isArray(data.items)) items = data.items;
            if (Array.isArray(items)) {
              items = items.map(sanitizeItem);
              items.forEach(it => ensureDailyIOArrays(it));
            }
            monthClosed = !!data.closed;
            renderItems();
            updateGrandTotal();
            updateRanking();
            updateCloseUI();
          } else applyTemplateIfNeeded();
        }, (err) => {
          console.error("Firestore ç›£è½éŒ¯èª¤", err);
          applyTemplateIfNeeded();
        });
      } else applyTemplateIfNeeded();
    }

    function updateCloseUI() {
      const app = document.querySelector(".app");
      const btn = document.getElementById("closeBtn");
      const note = document.getElementById("closeNote");
      if (monthClosed) {
        app.classList.add("closed-mode");
        btn.textContent = "ğŸ”“ è§£é™¤é—œå¸³";
        btn.classList.add("danger");
        note.textContent = "æœ¬æœˆå·²é—œå¸³ï¼šè€—æè³‡æ–™é–å®šä¸å¯ç·¨è¼¯ï¼Œå¦‚éœ€ä¿®æ”¹è«‹å…ˆã€Œè§£é™¤é—œå¸³ã€ã€‚";
      } else {
        app.classList.remove("closed-mode");
        btn.textContent = "ğŸ”’ æœ¬æœˆé—œå¸³";
        btn.classList.remove("danger");
        note.textContent = "æç¤ºï¼šå…ˆè¼¸å…¥æœŸåˆåº«å­˜ï¼›æ¯æ—¥è¨˜å…¥/å‡ºåº«ï¼›æœˆåº•å¡«å¯«ç›¤é»é‡ï¼Œç¢ºèªç„¡èª¤å¾Œå¯æŒ‰ã€Œæœ¬æœˆé—œå¸³ã€é–å®šè³‡æ–™ã€‚";
      }
    }

    function toggleCloseMonth() {
      if (!monthClosed) {
        if (!confirm("ç¢ºå®šè¦é—œå¸³ï¼Ÿé—œå¸³å¾Œæœ¬æœˆè€—æè³‡æ–™å°‡é–å®šä¸å¯ç·¨è¼¯ï¼ˆä¹‹å¾Œä»å¯è§£é™¤é—œå¸³ï¼‰ã€‚")) return;
        monthClosed = true;
      } else {
        if (!confirm("ç¢ºå®šè¦è§£é™¤é—œå¸³ï¼Ÿè§£é™¤å¾Œæœ¬æœˆè³‡æ–™å¯å†æ¬¡ä¿®æ”¹ã€‚")) return;
        monthClosed = false;
      }
      updateCloseUI();

      if (typeof db !== "undefined" && db) {
        const docId = "R" + currentYear + "_M" + currentMonth;
        db.collection("consumablesMonths").doc(docId).set({ closed: monthClosed }, { merge: true })
          .catch((err) => console.error("æ›´æ–°é—œå¸³ç‹€æ…‹å¤±æ•—", err));
      }
    }

    function onYearMonthChange() {
      const rocY = parseInt(document.getElementById("yearSelect").value, 10);
      const m = parseInt(document.getElementById("monthSelect").value, 10);
      loadYearMonth(rocY, m, false);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("yearSelect").value = "114";
      document.getElementById("monthSelect").value = "11";
      loadYearMonth(114, 11, false);
      document.getElementById("gallerySearch").addEventListener("input", renderGallery);
      updateCloseUI();
    });
  </script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCFMDVg7T3gXYobW0xQq8yy-XVglOJ_c-o",
    authDomain: "consumables-request-form-30575.firebaseapp.com",
    projectId: "consumables-request-form-30575",
    storageBucket: "consumables-request-form-30575.firebasestorage.app",
    messagingSenderId: "679332317468",
    appId: "1:679332317468:web:2aaaa865ad43bfc8e712d9",
    measurementId: "G-Z1Q2VMK9LX"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const analytics = firebase.analytics();
  const storage = firebase.storage();

  async function uploadPhotoToStorage(blob, path) {
    const storageRef = storage.ref().child(path);
    await storageRef.put(blob);
    return await storageRef.getDownloadURL();
  }
</script>

</body>
</html>
